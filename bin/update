#!/usr/bin/env bash
: <<'COPYRIGHT'
 Copyright (c) Vaimo Group. All rights reserved.
 See LICENSE_VAIMO.txt for license details.
COPYRIGHT

script_path=${BASH_SOURCE[0]}
script_root=$(dirname $(test -L ${script_path} && readlink -f ${script_path} || echo ${script_path}))

source ${script_root}/lib/output.sh

get_installation_root() {
    local installation_name=${1}

    (
        cd installations/${installation_name} &>/dev/null
        pwd
    )
}

sanitize() {
    rm -rf patches 2>/dev/null
    rm -rf modules 2>/dev/null
    rm -rf scenarios 2>/dev/null
    rm patches.json 2>/dev/null    
}

(
    bin/bootstrap-test-env
    
    cd test &>/dev/null
    
    sandbox_root=$(pwd)
    
    for installation in $(ls installations -1) ; do
        installation_root=$(get_installation_root ${installation})

        installation_label=$(cat ${installation_root}/.label)

        _line '=' 80
        _title "UPDATING INSTALLATION:" "${installation}" "${installation_label}"
        _line '=' 80

        (
            cd ${installation_root} &>/dev/null
            
            sanitize
            
            ln -s ${sandbox_root}/modules ${installation_root}
            echo '{}' > patches.json

            composer update
            
            sanitize
        )        
    done
)
